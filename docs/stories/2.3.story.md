# Story 2.3: Spending Agent - Transaction Analysis and Insights

## Status
Draft

## Story
**As a** user who wants to understand and optimize my spending habits,
**I want** an AI agent that provides comprehensive transaction analysis, spending insights, and personalized optimization recommendations,
**so that** I can make informed financial decisions and improve my financial health through conversational interaction.

**Architecture References:**
- Dual storage patterns: `docs/architecture/dual-storage-architecture.md`
- Component integration: `docs/architecture/components.md`
- Conversation patterns: `docs/stories/1.4.story.md` (AI Conversation Interface foundation)

## Acceptance Criteria

### Technical Foundation
1. Spending Agent implementation as LangGraph subgraph integrated with existing conversation system
2. Intelligent transaction fetching via MCP server Plaid tools with incremental updates
3. AI-powered transaction categorization with continuous user feedback learning integrated into agent workflow
4. Transaction accuracy features: re-categorization, split transactions, pending transaction management within conversational interface

### Analysis & Intelligence
5. Comprehensive spending pattern recognition (recurring expenses, seasonal trends, anomalies) delivered conversationally
6. Cash flow analysis with trend detection and forecasting capabilities presented through AI conversation
7. Spending personality profiling delivered through natural language explanations
8. Behavioral insight generation (spending triggers, timing patterns, stress spending) via conversational analysis
9. Risk tolerance assessment and financial motivation profiling through AI conversation

### Optimization Engine
10. Smart expense reduction recommendations with personality-tailored strategies delivered conversationally
11. Subscription and recurring payment optimization (duplicates, unused services, consolidation) via AI insights
12. Cost optimization opportunities with savings calculations based on spending patterns
13. Residual cash optimization with surplus allocation recommendations through conversation

### Budget & Planning
14. Conversational budget guidance with spending awareness and category insights
15. Intelligent budget recommendations delivered through AI conversation based on spending history and personality
16. Budget alerts and variance insights delivered conversationally with adjustment suggestions
17. Goal alignment analysis comparing spending habits to stated objectives through AI conversation

### User Experience & Interface
18. Conversational transaction queries with natural language processing
19. Personality-aware communication with adaptive tone and messaging based on user insights stored in Graphiti

### Technical Implementation Details
20. LangGraph subgraph implementation following established agent patterns from Stories 1.1-1.4
21. Dual storage integration: SQLite for user demographics (read-only), Graphiti for all spending insights and analysis results
22. MCP tool usage: Plaid tools for external data, Graphiti tools for context storage, agent-integrated analysis logic
23. Integration with existing conversation API (`/conversation/send`) rather than separate analysis endpoints
24. Reference architecture: Follow patterns documented in `dual-storage-architecture.md` and `components.md`

### Testing & Validation
25. Unit tests for spending analysis algorithms integrated within agent nodes
26. Integration tests for LangGraph subgraph workflow and state management
27. Conversation quality testing for AI analysis delivery and user comprehension
28. Dual storage testing: SQLite context retrieval and Graphiti insight storage validation

## Tasks / Subtasks

- [x] **LangGraph Spending Agent Subgraph** (AC: 1, 20, 21)
  - [x] Create SpendingAgent class following LangGraph patterns from Stories 1.1-1.4
  - [x] Implement agent initialization node with SQLite context retrieval
  - [x] Implement LLM-powered agent workflow routing with intelligent intent detection
  - [ ] Implement LLM-powered conversational response generation (PENDING - currently static responses)

- [ ] **Agent-Integrated Analysis Logic** (AC: 2, 3, 4, 5, 6, 7, 8, 9)
  - [x] Integrate transaction fetching via MCP Plaid tools within agent workflow
  - [ ] Implement AI-powered transaction categorization within agent processing
  - [ ] Integrate spending pattern analysis (recurring expenses, seasonal trends, anomalies)
  - [ ] Integrate cash flow analysis with trend detection
  - [ ] Implement spending personality profiling algorithm within agent
  - [ ] Integrate behavioral insight generation logic
  - [ ] Implement risk tolerance assessment within agent workflow
  - [ ] Add transaction re-categorization, split transactions, pending transaction management

- [ ] **Dual Storage Integration** (AC: 21, 22, 24)
  - [x] Integrate SQLite service for reading user demographics and personal context (COMPLETE)
  - [ ] Integrate Graphiti via MCP tools for storing spending insights and analysis results
  - [ ] Implement data flow patterns: SQLite (read demographics) → Analysis → Graphiti (store insights)
  - [ ] Add Graphiti integration using `get_graphiti_client()` to get and instance of the Graphiti MCP client and `add_episode` and `search` for episode storage and context search

- [ ] **Conversational Optimization Engine** (AC: 10, 11, 12, 13)
  - [ ] Implement personality-based optimization recommendations within agent responses
  - [ ] Integrate subscription optimization algorithm with conversational delivery
  - [ ] Implement cost optimization based on spending patterns for conversational presentation
  - [ ] Integrate surplus allocation recommendation engine with AI conversation

- [ ] **Conversational Budget & Planning** (AC: 14, 15, 16, 17)
  - [ ] Implement conversational budget guidance delivery through agent responses
  - [ ] Integrate budget recommendations for conversational delivery format
  - [ ] Transform budget alerts into conversational insights with adjustment suggestions
  - [ ] Implement goal alignment analysis for conversational presentation

- [ ] **Conversational Interface Integration** (AC: 18, 19, 23)
  - [ ] Integrate Spending Agent with existing `/conversation/send` API endpoint
  - [ ] Implement personality-aware response generation using Graphiti context
  - [ ] Add natural language transaction query processing within agent
  - [ ] Implement adaptive communication tone based on stored user insights

- [ ] **Testing & Validation** (AC: 25, 26, 27, 28)
  - [ ] Create unit tests for agent-integrated analysis algorithms
  - [ ] Implement integration tests for LangGraph subgraph workflow and state management
  - [ ] Add conversation quality testing for AI analysis delivery and user comprehension
  - [ ] Create dual storage testing: SQLite context retrieval and Graphiti insight storage validation
  - [ ] Test MCP tool integration for Plaid data fetching and Graphiti storage

## Dev Notes

### Architecture Overview
This story implements a conversational Spending Agent as a LangGraph subgraph that integrates with the existing conversation system established in Stories 1.1-1.4. All analysis and insights are delivered through natural conversation rather than separate APIs or complex UI components.

### Key Integration Points
- **Conversation System**: Integrates with `/conversation/send` endpoint from Story 1.4
- **Authentication**: Uses existing auth system from Stories 1.1-1.2
- **Data Storage**: Follows dual storage pattern (SQLite for demographics, Graphiti for insights)
- **External Data**: Uses MCP Plaid tools for transaction fetching

### Technology Stack
- **AI Framework**: LangGraph subgraph architecture
- **External Integration**: MCP tools for Plaid and Graphiti access
- **Storage**: SQLite (read-only demographics) + Graphiti (analysis results)
- **Delivery**: Conversational interface via existing chat system

### Testing Strategy
Focus on conversation quality and agent workflow testing rather than API endpoint testing. Validate that financial insights are delivered clearly and comprehensibly through AI conversation.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-25 | 2.0 | Complete rewrite for conversational architecture alignment | SM Agent |
| 2025-09-02 | 1.0 | Initial story creation | SM Agent |

## Dev Agent Record

### Agent Model Used
- Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References  
*This section will be populated by the development agent during implementation*

### Completion Notes List

#### ✅ COMPLETED: Basic SpendingAgent Foundation (Aug 2025)

**What Was Actually Implemented:**
- ✅ **SpendingAgent LangGraph Subgraph**: Basic 3-node architecture with conditional routing to 5 specialized intent nodes
- ✅ **SQLite Integration**: Real UserContextDAO integration for retrieving user demographics and financial context 
- ✅ **Intent-Based Routing**: Keyword-based intent detection routing to specialized nodes (spending_analysis, budget_planning, optimization, transaction_query, general_spending)
- ✅ **Professional Response Generation**: Static professional responses for each intent type
- ✅ **Comprehensive Testing**: 16 tests covering initialization, routing, specialized nodes, and error handling (all passing)

**Architecture Implemented:**
```
START → initialize (real DAO) → route_intent → [specialized_node] → END
```

**Key Limitations - What's NOT Implemented:**
- ❌ **No Real Analysis**: All responses are static text, no actual transaction analysis
- ❌ **No MCP Tool Integration**: No Plaid data fetching, no Graphiti storage
- ❌ **No AI-Powered Features**: No LLM calls, just keyword-based intent detection
- ❌ **No Financial Logic**: No spending patterns, cash flow analysis, optimization algorithms
- ❌ **No API Integration**: Not integrated with `/conversation/send` endpoint
- ❌ **Mock Personality**: Simple professional tone, no real personality adaptation

**Status**: This completes only the **basic infrastructure foundation** for the SpendingAgent. The actual financial analysis, MCP integrations, and AI-powered features remain unimplemented.

#### ✅ COMPLETED: LLM Integration Architecture (September 2025)

**What Was Additionally Implemented:**
- ✅ **LLM-Powered Intent Detection**: Replaced keyword-based intent detection with real LLM calls using structured prompts
- ✅ **Multi-LLM Provider Support**: Extended LLM service to support OpenAI, Anthropic Claude, and Google Gemini
- ✅ **Real LLM Integration**: SpendingAgent now uses self.llm for intelligent intent classification 
- ✅ **Provider-Specific Configuration**: Pydantic models with provider-specific settings (OpenAI extra="forbid")
- ✅ **Comprehensive LLM Testing**: Real LLM integration tests for all three providers with proper environment-based skipping
- ✅ **API Compatibility Fixes**: Resolved Gemini API message format requirements
- ✅ **Fallback Intent Detection**: Graceful degradation when LLM is unavailable
- ✅ **Configuration System Updates**: Environment variable support for all three LLM providers

**Architecture Enhanced:**
```
START → initialize (real DAO) → route_intent (LLM-powered) → [specialized_node] → END
```

**Key Progress - What's NOW Implemented:**
- ✅ **Real LLM Calls**: Intent detection uses actual LLM providers instead of keyword matching
- ✅ **Multi-Provider Architecture**: Supports OpenAI GPT-4o, Anthropic Claude Sonnet, Google Gemini Flash
- ✅ **Intelligent Routing**: Context-aware intent detection using user demographics and message content
- ✅ **Provider Fallbacks**: Graceful handling of API failures and missing credentials
- ✅ **Real API Testing**: Integration tests that validate all three LLM providers

**Key Limitations - What's Still NOT Implemented:**
- ❌ **No LLM Response Generation**: Intent nodes still use static responses instead of LLM-generated content
- ❌ **No Real Analysis**: No actual transaction analysis or financial calculations
- ❌ **No MCP Tool Integration**: No Plaid data fetching, no Graphiti storage  
- ❌ **No Financial Logic**: No spending patterns, cash flow analysis, optimization algorithms
- ❌ **No API Integration**: Not integrated with `/conversation/send` endpoint

**Status**: This completes the **LLM integration architecture** for intelligent intent routing. The next phase requires implementing LLM-powered response generation and integrating real financial data analysis.

### File List
*This section will be populated by the development agent during implementation*

## QA Results

*This section will be populated by the QA Agent after story completion*
