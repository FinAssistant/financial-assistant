# Story 1.7: Graphiti Database Integration via MCP Server

## Status

Ready for Development

## Story

**As a** system,  
**I want** Graphiti graph database accessible through the MCP server,  
**So that** AI agents can store and query contextual relationships and memory.

## Acceptance Criteria

**Functional Requirements:**

1. Graphiti database setup using https://github.com/getzep/graphiti/tree/main/mcp_server#docker-deployment exactly as documented
2. Validation that Graphiti's automatic entity extraction works for financial conversations and context
3. Docker-compose orchestration leveraging Graphiti's provided docker-compose configuration
4. Integration of Graphiti MCP tools into our existing MCP server (NOT reimplementing them)
5. Orchestrator agent integration with hardcoded financial keyword detection for storing user conversations
6. Memory persistence for conversation context across agents using Graphiti's episode system
7. Query tools using Graphiti's existing MCP tools (search, add_episode, etc.)
8. Integration testing with Graphiti's containerized MCP server
9. Development documentation for using Graphiti's MCP tools

## Tasks / Subtasks

### 1. Graphiti Proof of Concept - Financial Schema Validation

- [ ] Set up basic Graphiti docker environment for testing (AC: 1, 3)
  - [ ] Copy/adapt docker-compose.yml from https://github.com/getzep/graphiti/tree/main/mcp_server
  - [ ] Start Graphiti containers using their docker-compose setup
  - [ ] Use Graphiti's environment variable configuration as-is
  - [ ] Verify Graphiti MCP server container is running and accessible
- [ ] Test Graphiti's automatic financial entity extraction (AC: 2, 6)
  - [ ] Create test episodes with financial goals and verify Graphiti extracts entities
  - [ ] Create test episodes with risk preferences and verify relationship creation
  - [ ] Create test episodes with spending constraints and verify context linking
  - [ ] Use search to verify financial context can be retrieved
  - [ ] Verify Graphiti's automatic schema works for our financial use cases

### 2. Docker Compose Setup Using Graphiti's Solution

- [ ] Complete docker-compose integration (AC: 1, 3)
  - [ ] Add our FastAPI service to Graphiti's existing docker-compose setup (Dockerfile already exists)
  - [ ] Configure networking between our FastAPI and Graphiti's MCP server container
  - [ ] Ensure our application SQLite database file is mounted from filesystem for persistence
  - [ ] NO custom health checks - use Graphiti's existing container health
- [ ] Update development workflow to use Graphiti's docker setup (AC: 3)
  - [ ] Update start-dev.sh to use `docker-compose up --build` with Graphiti services (no need to build Graphiti)
  - [ ] Ensure `docker-compose up --build` starts complete solution with latest development code (includes building the frontend)
  - [ ] Update README with Graphiti's docker deployment instructions

### 3. Create Shared MCP Client for Graphiti Integration

- [ ] Create new shared MCP client module (AC: 4, 7)
  - [ ] Create backend/mcp_clients/graphiti_client.py (separate from orchestrator)
  - [ ] Implement MultiServerMCPClient instance for Graphiti connections
  - [ ] Configure connection to Graphiti's containerized MCP server
  - [ ] Make client reusable by other agents (not just orchestrator)
  - [ ] Test direct connection to Graphiti's add_episode and search tools
  - [ ] Document client interface and expected parameters

### 4. Orchestrator Agent Integration with Graphiti

- [ ] Implement hardcoded financial keyword detection in orchestrator (AC: 5)
  - [ ] Create financial keywords list in `backend/financial_keywords.py` as a Python constant (see file for full list)
  - [ ] Add keyword detection logic to orchestrator conversation processing
  - [ ] Store user messages containing financial keywords in Graphiti via MCP tools
  - [ ] Include conversation context (agent type, session info) in episode metadata
- [ ] Update orchestrator to use shared Graphiti MCP client (AC: 5, 6)
  - [ ] Import and use GraphitiMCPClient in orchestrator agent workflow
  - [ ] Call add_episode when financial keywords detected
  - [ ] CRITICAL: Use user_id as group_id to ensure user data isolation
  - [ ] Include user_id, group_id (same as user_id), message content, and metadata in episodes
  - [ ] Ensure agents only access data from group_id matching authenticated user
  - [ ] Handle Graphiti storage errors gracefully (log but don't break conversation)

### 5. Testing & Documentation

- [ ] Keep testing environment simple (AC: 8)
  - [ ] Mock the Graphiti MCP server for testing - avoid docker-compose complexity
  - [ ] Test MCP client connection logic with mocked responses
  - [ ] Test orchestrator keyword detection and storage calls
  - [ ] Focus on unit tests - avoid container integration for now
- [ ] Create simple documentation in docs/architecture (AC: 9)
  - [ ] Document which Graphiti MCP tools we're using and how
  - [ ] Document financial keyword detection logic and keyword list
  - [ ] Document user data isolation using group_id = user_id pattern
  - [ ] Document Graphiti's automatic financial entity extraction capabilities
  - [ ] All documentation extends existing files in docs/architecture directory

## Dev Notes

### Relevant Source Tree

```
ai-financial-assistant/
├── docker-compose.yml           # Adapted from Graphiti's docker deployment
├── backend/
│   ├── mcp_clients/
│   │   └── graphiti_client.py   # Shared MCP client for Graphiti (NEW)
│   ├── tests/
│   │   └── test_graphiti_integration.py # Integration tests (NEW)
│   └── pyproject.toml           # Add MCP client dependencies
├── scripts/
│   └── start-dev.sh            # Updated to use docker-compose
└── .env                        # Graphiti's required environment variables
```

### Integration Context from Story 1.6

- MCP Server Foundation completed with FastMCP v2.12.0
- Existing tools: `mcp_health_check`, `echo`, `get_current_time`, Plaid tools
- Pattern: @mcp.tool decorator for tool registration
- MCP server mounted at `/mcp` endpoint with combined lifespan

### Graphiti Docker Deployment Reference

- **Primary Source**: https://github.com/getzep/graphiti/tree/main/mcp_server#docker-deployment
- **Approach**: Use Graphiti's docker-compose.yml as starting point
- **Integration**: Add our FastAPI service to their compose configuration
- **Tools**: Use Graphiti's existing MCP tools via MCP client connection
- **NO Custom Implementation**: Leverage everything Graphiti provides out-of-the-box

### Shared MCP Client Pattern

Create reusable MCP client for all agents to use:

```python
# backend/mcp_clients/graphiti_client.py
class GraphitiMCPClient:
    def __init__(self):
        self.client = MultiServerMCPClient()

    async def connect(self):
        await self.client.add_server("graphiti", "tcp://graphiti-mcp-server:8080")

    async def add_episode(self, user_id: str, content: str):
        return await self.client.call_tool("graphiti", "add_episode", {
            "user_id": user_id,
            "content": content,
            "group_id": user_id
        })

# Usage in orchestrator and other agents
from backend.mcp_clients.graphiti_client import GraphitiMCPClient
```

### Dual-Storage Architecture Context

- **Graph Database Purpose**: Store dynamic financial context and relationships [Source: docs/architecture/dual-storage-architecture.md#Graphiti Storage]
- **Episode-Based Storage**: Use Graphiti's conversation episodes for financial context
- **Agent Access**: Agents call Graphiti tools through our MCP server proxy

### Financial Context Validation Using Graphiti's Episode System

Proof of concept approach to validate Graphiti works for our use cases:

- **Financial Episodes**: Test storing financial conversations as episodes
- **Entity Extraction**: Verify Graphiti automatically identifies financial entities (goals, amounts, timelines)
- **Relationship Discovery**: Test that Graphiti learns relationships between financial concepts
- **Context Retrieval**: Validate search can find relevant financial context
- **NO Custom Schema**: Confirm Graphiti's automatic approach works for financial data

### Security Requirements

- Use Graphiti's container security model as-is
- Configure MCP client authentication per Graphiti's documentation
- **CRITICAL User Data Isolation**: Each user's data MUST be isolated using group_id
  - Set group_id = user_id for all Graphiti operations
  - Agents must only query data from group_id matching authenticated user
  - Never allow cross-user data access through group_id mixing
  - All add_episode calls must include proper group_id parameter

### Testing

**Testing Standards from Architecture:**

- **Test Framework**: pytest with mocking for simplicity [Source: docs/architecture/testing-strategy.md#Backend Tests]
- **Testing Focus**: Mock Graphiti MCP server responses for unit testing
- **Keep It Simple**: Use mocking for Graphiti MCP server - avoid container complexity

**Specific Testing Requirements:**

1. Unit tests with mocked Graphiti MCP server responses
2. Test MCP client connection logic with mock server
3. Test keyword detection and add_episode calls with mocks
4. Test error handling when Graphiti calls fail
5. Regression tests to ensure existing MCP tools continue working

**Test Execution:**

```bash
# Simple unit tests with mocking - no containers needed
pytest tests/test_graphiti_integration.py -v
```

## Change Log

| Date       | Version | Description                                                      | Author             |
| ---------- | ------- | ---------------------------------------------------------------- | ------------------ |
| 2025-09-05 | 1.0     | Initial story leveraging Graphiti's docker MCP server deployment | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated after implementation_
